{% extends 'admin/base.html' %}

{% block title %}Manage Gallery - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Gallery Management</h1>
        <a href="{{ url_for('admin_upload_gallery') }}" class="btn btn-primary">
            <i class="fas fa-upload"></i> Upload Images
        </a>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">All Gallery Images (Grouped by Category)</h5>
            <div class="d-flex gap-2 align-items-center flex-wrap" style="row-gap: 8px;">
                {% if groups %}
                <form action="{{ url_for('admin_delete_gallery', id=0) }}" method="POST" class="d-inline">
                    <button type="submit" id="delete-selected" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                </form>
                {% endif %}
                <form action="{{ url_for('admin_set_gallery_category_order') }}" method="POST" class="d-flex align-items-center gap-2">
                    <label for="cat-order" class="form-label mb-0 small">Category order:</label>
                    <input id="cat-order" name="order" type="text" class="form-control form-control-sm" style="width: 260px;" placeholder="square,three_four,portrait,landscape" value="{{ (settings.gallery_category_order if settings and settings.gallery_category_order) or 'square,three_four,portrait,landscape' }}">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Apply</button>
                </form>
            </div>
        </div>
        <div class="card-body">
            {% if groups %}
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all">
                    <label class="form-check-label" for="select-all">
                        Select All
                    </label>
                </div>
            </div>
            {% for group_name, images in groups %}
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-uppercase">{{ group_name.replace('_', ' ') }}</h6>
                <button class="btn btn-success btn-sm save-order-cat" data-category="{{ group_name }}">
                    <i class="fas fa-save"></i> Save {{ group_name }} Order
                </button>
            </div>
            <div class="row gallery-draggable" data-category="{{ group_name }}" style="row-gap: 1rem;">
                {% for image in images %}
                <div class="col-lg-3 col-md-4 col-sm-6" draggable="true" data-id="{{ image.id }}">
                    <div class="card h-100 shadow-sm reorder-card">
                        <img src="{{ url_for('get_gallery_image', image_id=image.id) }}"
                             alt="{{ image.title }}"
                             class="card-img-top"
                             loading="lazy"
                             style="height: 180px; object-fit: cover;">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; padding: 5px; text-align: center;">
                            {{ image.image_filename }}
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="selected_images" value="{{ image.id }}" id="image-{{ image.id }}">
                                <label class="form-check-label" for="image-{{ image.id }}">
                                    {{ image.title or 'Untitled Image' }}
                                </label>
                            </div>
                            <p class="card-text small text-muted">
                                {{ image.caption or 'No caption' }}
                            </p>
                            <p class="card-text small text-muted">
                                <i class="far fa-calendar-alt me-1"></i> {{ image.upload_date.strftime('%b %d, %Y') }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center small text-muted">
                                <span>Id: {{ image.id }}</span>
                                <span>Order: {{ image.display_order or '-' }}</span>
                            </div>
                            <form action="{{ url_for('admin_delete_gallery', id=image.id) }}" method="POST" class="d-inline mt-2 w-100">
                                <button type="submit" class="btn btn-sm btn-danger delete-btn w-100">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <hr>
            {% endfor %}
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> No gallery images found. Click the "Upload Images" button to add images to the gallery.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const containers = document.querySelectorAll('.gallery-draggable');
  let dragEl = null;

  containers.forEach(container => {
    container.querySelectorAll('[draggable="true"]').forEach(el => {
      el.addEventListener('dragstart', e => {
        dragEl = el;
        e.dataTransfer.effectAllowed = 'move';
        el.classList.add('opacity-50');
      });
      el.addEventListener('dragend', () => {
        el.classList.remove('opacity-50');
        dragEl = null;
      });
      el.addEventListener('dragover', e => {
        e.preventDefault();
        const target = e.currentTarget;
        if (!dragEl || dragEl === target) return;
        const rect = target.getBoundingClientRect();
        const before = (e.clientY - rect.top) / rect.height < 0.5;
        const parent = target.parentNode;
        if (before) {
          parent.insertBefore(dragEl, target);
        } else {
          parent.insertBefore(dragEl, target.nextSibling);
        }
      });
    });
  });

  document.querySelectorAll('.save-order-cat').forEach(btn => {
    btn.addEventListener('click', async () => {
      const cat = btn.getAttribute('data-category');
      const container = document.querySelector(`.gallery-draggable[data-category="${cat}"]`);
      const ids = Array.from(container.querySelectorAll('[draggable="true"]')).map(el => parseInt(el.getAttribute('data-id')));
      try {
        const resp = await fetch('{{ url_for('admin_reorder_gallery_category') }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: cat, ordered_ids: ids })
        });
        const data = await resp.json();
        if (data && data.ok) {
          alert(`Order saved for ${cat}!`);
          location.reload();
        } else {
          alert('Failed to save order: ' + (data && data.error ? data.error : 'Unknown error'));
        }
      } catch (e) {
        alert('Network error while saving order');
      }
    });
  });
});
</script>
{% endblock %}
